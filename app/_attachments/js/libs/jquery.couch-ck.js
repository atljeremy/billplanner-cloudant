// $.couch is used to communicate with a CouchDB server, the server methods can
// be called directly without creating an instance. Typically all methods are
// passed an <code>options</code> object which defines a success callback which
// is called with the data returned from the http request to CouchDB, you can
// find the other settings that can be used in the <code>options</code> object
// from <a href="http://api.jquery.com/jQuery.ajax/#jQuery-ajax-settings">
// jQuery.ajax settings</a>
//
//     $.couch.activeTasks({
//       success: function (data) {
//         console.log(data);
//       }
//     });
//
// Outputs (for example):
//
//     [
//       {
//         "pid" : "<0.11599.0>",
//         "status" : "Copied 0 of 18369 changes (0%)",
//         "task" : "recipes",
//         "type" : "Database Compaction"
//       }
//     ]
(function(a){function b(a){var b=a.split("/");if(b[0]=="_design"){b.shift();return"_design/"+encodeURIComponent(b.join("/"))}return encodeURIComponent(a)}function d(b,c,d,e){var f={contentType:"application/json",headers:{Accept:"application/json"}};c=a.extend({successStatus:200},c);e=a.extend(f,e);d=d||"Unknown error";return a.ajax(a.extend(a.extend({type:"GET",dataType:"json",beforeSend:function(a){if(e&&e.headers)for(var b in e.headers)a.setRequestHeader(b,e.headers[b])},complete:function(b){try{var e=a.parseJSON(b.responseText)}catch(f){c.error?c.error(b.status,b,f):alert(d+": "+f);return}c.ajaxStart&&c.ajaxStart(e);if(b.status==c.successStatus){c.beforeSuccess&&c.beforeSuccess(b,e);c.success&&c.success(e)}else c.error?c.error(b.status,e&&e.error||d,e&&e.reason||"no response"):alert(d+": "+e.reason)}},b),e))}function e(a){var a=a||{};if(typeof a.ensure_full_commit!="undefined"){var b=a.ensure_full_commit;delete a.ensure_full_commit;return function(a){a.setRequestHeader("Accept","application/json");a.setRequestHeader("X-Couch-Full-Commit",b.toString())}}}function f(b){var c=[];if(typeof b=="object"&&b!==null)for(var d in b){if(a.inArray(d,["error","success","beforeSuccess","ajaxStart"])>=0)continue;var e=b[d];a.inArray(d,["key","startkey","endkey"])>=0&&(e=g(e));c.push(encodeURIComponent(d)+"="+encodeURIComponent(e))}return c.length?"?"+c.join("&"):""}function g(a){return a!==null?JSON.stringify(a):null}a.couch=a.couch||{};var c=[];a.extend(a.couch,{urlPrefix:"https://onglandistanyboubtaindeg:7kD3juiBXaEP82dEXBmiGQkX@atljeremy.cloudant.com",activeTasks:function(a){return d({url:this.urlPrefix+"/_active_tasks"},a,"Active task status could not be retrieved")},allDbs:function(a){return d({url:this.urlPrefix+"/_all_dbs"},a,"An error occurred retrieving the list of all databases")},config:function(a,b,c,e){var f={url:this.urlPrefix+"/_config/"};if(b){f.url+=encodeURIComponent(b)+"/";c&&(f.url+=encodeURIComponent(c))}if(e===null)f.type="DELETE";else if(e!==undefined){f.type="PUT";f.data=g(e);f.contentType="application/json";f.processData=!1}return d(f,a,"An error occurred retrieving/updating the server configuration")},session:function(b){b=b||{};return a.ajax({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);c.status==200?b.success&&b.success(d):b.error?b.error(c.status,d.error,d.reason):alert("An error occurred getting session info: "+d.reason)}})},userDb:function(b){return a.couch.session({success:function(c){var d=a.couch.db(c.info.authentication_db);b(d)}})},signup:function(b,c,d){d=d||{};b=this.prepareUserDoc(b,c);return a.couch.userDb(function(a){a.saveDoc(b,d)})},prepareUserDoc:function(b,c){if(typeof hex_sha1=="undefined"){alert("creating a user doc requires sha1.js to be loaded in the page");return}var d="org.couchdb.user:";b._id=b._id||d+b.name;if(c){b.salt=a.couch.newUUID();b.password_sha=hex_sha1(c+b.salt)}b.type="user";b.roles||(b.roles=[]);return b},login:function(b){b=b||{};return a.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:b.name,password:b.password},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);c.status==200?b.success&&b.success(d):b.error?b.error(c.status,d.error,d.reason):alert("An error occurred logging in: "+d.reason)}})},logout:function(b){b=b||{};return a.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);c.status==200?b.success&&b.success(d):b.error?b.error(c.status,d.error,d.reason):alert("An error occurred logging out: "+d.reason)}})},db:function(c,h){function j(a){if(a._id&&a._rev&&i[a._id]&&i[a._id].rev==a._rev){if(typeof Base64=="undefined"){alert("please include /_utils/script/base64.js in the page for base64 support");return!1}a._attachments=a._attachments||{};a._attachments["rev-"+a._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(i[a._id].raw)};return!0}}h=h||{};var i={};return{name:c,uri:this.urlPrefix+"/"+encodeURIComponent(c)+"/",compact:function(b){a.extend(b,{successStatus:202});return d({type:"POST",url:this.uri+"_compact",data:"",processData:!1},b,"The database could not be compacted")},viewCleanup:function(b){a.extend(b,{successStatus:202});return d({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},b,"The views could not be cleaned up")},compactView:function(b,c){a.extend(c,{successStatus:202});return d({type:"POST",url:this.uri+"_compact/"+b,data:"",processData:!1},c,"The view could not be compacted")},create:function(b){a.extend(b,{successStatus:201});return d({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},b,"The database could not be created")},drop:function(a){return d({type:"DELETE",url:this.uri},a,"The database could not be deleted")},info:function(a){return d({url:this.uri},a,"Database information could not be retrieved")},changes:function(b,c){function k(b){a.each(i,function(){this(b)})}function l(){var e=a.extend({heartbeat:1e4},c,{feed:"longpoll",since:b});d({url:g.uri+"_changes"+f(e)},c,"Error connecting to "+g.uri+"/_changes.")}c=c||{};var e=100,g=this,h=!0,i=[],j={onChange:function(a){i.push(a)},stop:function(){h=!1}};c.success=function(a){e=100;if(h){b=a.last_seq;k(a);l()}};c.error=function(){if(h){setTimeout(l,e);e*=2}};b?l():g.info({success:function(a){b=a.update_seq;l()}});return j},allDocs:function(a){var b="GET",c=null;if(a.keys){b="POST";var e=a.keys;delete a.keys;c=g({keys:e})}return d({type:b,data:c,url:this.uri+"_all_docs"+f(a)},a,"An error occurred retrieving a list of all documents")},allDocsWithDetails:function(a){var b="GET",c=null;return d({type:b,data:c,url:this.uri+"_all_docs?include_docs=true"},a,"An error occurred retrieving a list of all documents")},allDesignDocs:function(b){return this.allDocs(a.extend({startkey:"_design",endkey:"_design0"},b))},allApps:function(b){b=b||{};var d=this;b.eachApp?this.allDesignDocs({success:function(e){a.each(e.rows,function(){d.openDoc(this.id,{success:function(a){var d,e,f=a._id.split("/");f.shift();f=f.join("/");d=a.couchapp&&a.couchapp.index;d?e=["",c,a._id,d].join("/"):a._attachments&&a._attachments["index.html"]&&(e=["",c,a._id,"index.html"].join("/"));e&&b.eachApp(f,e,a)}})})}}):alert("Please provide an eachApp function for allApps()")},openDoc:function(c,e,g){e=e||{};h.attachPrevRev||e.attachPrevRev?a.extend(e,{beforeSuccess:function(a,b){i[b._id]={rev:b._rev,raw:a.responseText}}}):a.extend(e,{beforeSuccess:function(a,b){b["jquery.couch.attachPrevRev"]&&(i[b._id]={rev:b._rev,raw:a.responseText})}});return d({url:this.uri+b(c)+f(e)},e,"The document could not be retrieved",g)},saveDoc:function(c,d){d=d||{};var h=this,i=e(d);if(c._id===undefined)var k="POST",l=this.uri;else var k="PUT",l=this.uri+b(c._id);var m=j(c);return a.ajax({type:k,url:l+f(d),contentType:"application/json",dataType:"json",data:g(c),beforeSend:i,complete:function(b){var e=a.parseJSON(b.responseText);if(b.status==200||b.status==201||b.status==202){c._id=e.id;c._rev=e.rev;m?h.openDoc(c._id,{attachPrevRev:!0,success:function(a){c._attachments=a._attachments;d.success&&d.success(e)}}):d.success&&d.success(e)}else d.error?d.error(b.status,e.error,e.reason):alert("The document could not be saved: "+e.reason)}})},bulkSave:function(b,c){var h=e(c);a.extend(c,{successStatus:201,beforeSend:h});return d({type:"POST",url:this.uri+"_bulk_docs"+f(c),contentType:"application/json",data:g(b)},c,"The documents could not be saved")},removeDoc:function(a,c){return d({type:"DELETE",url:this.uri+b(a._id)+f({rev:a._rev})},c,"The document could not be deleted")},bulkRemove:function(b,c){b.docs=a.each(b.docs,function(a,b){b._deleted=!0});a.extend(c,{successStatus:201});return d({type:"POST",url:this.uri+"_bulk_docs"+f(c),data:g(b)},c,"The documents could not be deleted")},copyDoc:function(c,e,f){f=a.extend(f,{complete:function(b){var c=a.parseJSON(b.responseText);b.status==201?e.success&&e.success(c):e.error?e.error(b.status,c.error,c.reason):alert("The document could not be copied: "+c.reason)}});return d({type:"COPY",url:this.uri+b(c)},e,"The document could not be copied",f)},query:function(a,b,c,e){c=c||"javascript";typeof a!="string"&&(a=a.toSource?a.toSource():"("+a.toString()+")");var h={language:c,map:a};if(b!=null){typeof b!="string"&&(b=b.toSource?b.toSource():"("+b.toString()+")");h.reduce=b}return d({type:"POST",url:this.uri+"_temp_view"+f(e),contentType:"application/json",data:g(h)},e,"An error occurred querying the database")},list:function(a,b,c,e){var a=a.split("/"),c=c||{},h="GET",i=null;if(c.keys){h="POST";var j=c.keys;delete c.keys;i=g({keys:j})}return d({type:h,data:i,url:this.uri+"_design/"+a[0]+"/_list/"+a[1]+"/"+b+f(c)},e,"An error occured accessing the list")},updateDoc:function(b,c,d,e){var g=b.split("/"),d=d||{},h="PUT",i=null;return a.ajax({type:h,data:i,beforeSend:function(a){a.setRequestHeader("Accept","*/*")},complete:function(a){var b=a.responseText;a.status==201?d.success&&d.success(b):d.error?d.error(a.status,b.error,b.reason):alert("An error occurred getting session info: "+b.reason)},url:this.uri+"_design/"+g[0]+"/_update/"+g[1]+"/"+c+f(d)})},view:function(a,b){var a=a.split("/"),b=b||{},c="GET",e=null;if(b.keys){c="POST";var h=b.keys;delete b.keys;e=g({keys:h})}return d({type:c,data:e,url:this.uri+"_design/"+a[0]+"/_view/"+a[1]+f(b)},b,"An error occurred accessing the view")},getDbProperty:function(a,b,c){return d({url:this.uri+a+f(b)},b,"The property could not be retrieved",c)},setDbProperty:function(a,b,c,e){return d({type:"PUT",url:this.uri+a+f(c),data:JSON.stringify(b)},c,"The property could not be updated",e)}}},encodeDocId:b,info:function(a){return d({url:this.urlPrefix+"/"},a,"Server information could not be retrieved")},replicate:function(b,c,e,f){f=a.extend({source:b,target:c},f);f.continuous&&!f.cancel&&(e.successStatus=202);return d({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(f),contentType:"application/json"},e,"Replication failed")},newUUID:function(a){a===undefined&&(a=1);c.length||d({url:this.urlPrefix+"/_uuids",data:{count:a},async:!1},{success:function(a){c=a.uuids}},"Failed to retrieve UUID batch.");return c.shift()}})})(jQuery);